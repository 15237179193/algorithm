## é¢˜ç›®æè¿°

è¡¨ï¼šStadium

```
+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| id            | int     |
| visit_date    | date    |
| people        | int     |
+---------------+---------+
```

visit_date æ˜¯è¡¨çš„ä¸»é”®

æ¯æ—¥äººæµé‡ä¿¡æ¯è¢«è®°å½•åœ¨è¿™ä¸‰åˆ—ä¿¡æ¯ä¸­ï¼šåºå· (id)ã€æ—¥æœŸ (visit_date)ã€Â äººæµé‡ (people)

æ¯å¤©åªæœ‰ä¸€è¡Œè®°å½•ï¼Œæ—¥æœŸéšç€ id çš„å¢žåŠ è€Œå¢žåŠ 
Â 


ç¼–å†™ä¸€ä¸ª SQL æŸ¥è¯¢ä»¥æ‰¾å‡ºæ¯è¡Œçš„äººæ•°å¤§äºŽæˆ–ç­‰äºŽ 100 ä¸” id è¿žç»­çš„ä¸‰è¡Œæˆ–æ›´å¤šè¡Œè®°å½•ã€‚

è¿”å›žæŒ‰ visit_date å‡åºæŽ’åˆ—çš„ç»“æžœè¡¨ã€‚

æŸ¥è¯¢ç»“æžœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚

Stadium table:

```
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 1    | 2017-01-01 | 10        |
| 2    | 2017-01-02 | 109       |
| 3    | 2017-01-03 | 150       |
| 4    | 2017-01-04 | 99        |
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+
```

Result table:

```
+------+------------+-----------+
| id   | visit_date | people    |
+------+------------+-----------+
| 5    | 2017-01-05 | 145       |
| 6    | 2017-01-06 | 1455      |
| 7    | 2017-01-07 | 199       |
| 8    | 2017-01-09 | 188       |
+------+------------+-----------+
```
 
id ä¸º 5ã€6ã€7ã€8 çš„å››è¡Œ id è¿žç»­ï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰ >= 100 çš„äººæ•°è®°å½•ã€‚

è¯·æ³¨æ„ï¼Œå³ä½¿ç¬¬ 7 è¡Œå’Œç¬¬ 8 è¡Œçš„ visit_date ä¸æ˜¯è¿žç»­çš„ï¼Œè¾“å‡ºä¹Ÿåº”å½“åŒ…å«ç¬¬ 8 è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦è€ƒè™‘ id è¿žç»­çš„è®°å½•ã€‚

ä¸è¾“å‡º id ä¸º 2 å’Œ 3 çš„è¡Œï¼Œå› ä¸ºè‡³å°‘éœ€è¦ä¸‰æ¡ id è¿žç»­çš„è®°å½•ã€‚



æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰

é“¾æŽ¥ï¼šhttps://leetcode-cn.com/problems/human-traffic-of-stadium

è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æŽˆæƒï¼Œéžå•†ä¸šè½¬è½½è¯·æ³¨æ˜Žå‡ºå¤„ã€‚

## æ•°æ®è¡¨ç»“æž„

```
CREATE TABLE `stadium` (
  `id` int(11) DEFAULT '0' COMMENT 'åºå·',
  `visit_date` date NOT NULL COMMENT 'æ—¥æœŸï¼Œä¸»é”®',
  `people` int(11) DEFAULT '0' COMMENT 'äººæµé‡',
  PRIMARY KEY (`visit_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='ä½“è‚²é¦†äººæµé‡';

INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (1, '2017-01-01', 10);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (2, '2017-01-02', 109);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (3, '2017-01-03', 150);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (4, '2017-01-04', 99);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (5, '2017-01-05', 145);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (6, '2017-01-06', 1455);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (7, '2017-01-07', 199);
INSERT INTO `test`.`stadium`(`id`, `visit_date`, `people`) VALUES (8, '2017-01-09', 188);

```

## é—®é¢˜è§£ç­”

1. MySQL find_in_set() + group_concat() + group by + having + å˜é‡ + where

    ```
    -- ä½¿ç”¨find_in_set()å‡½æ•°æŸ¥è¯¢æœ€ç»ˆæ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œå¾—åˆ°çš„æ•°æ®å³ä¸ºæœ€ç»ˆéœ€è¦çš„ç»“æžœ
    select id, visit_date, people
    from stadium as s, (
        -- æ ¹æ®å­—æ®µflagåˆ†ç»„å¹¶ç­›é€‰åŒç»„å†…flagæ•°é‡ >= 3 çš„æ—¥æœŸï¼Œå¹¶é€šè¿‡GROUP_CONCAT()å‡½æ•°å°†ç»„å†…æ—¥æœŸè¿žæŽ¥æˆå­—ç¬¦ä¸²ï¼Œä¸ºä¸‹ä¸€æ­¥æŸ¥è¯¢åšå‡†å¤‡
        select group_concat(visit_date) as peoples
        from (
            -- é€šè¿‡å˜é‡çš„æ–¹å¼å°†idè¿žç»­çš„æ•°æ®è¿›è¡Œæ ‡è®°ï¼Œè¿™ä¸€æ­¥çš„æ“ä½œæ˜¯ä¸ºäº†å¤–å±‚æ ¹æ®flagåˆ†ç»„ç­›é€‰è¿žç»­idæ•°é‡ >= 3 çš„æŸ¥è¯¢åšå‡†å¤‡
            -- åŽŸç†ï¼šè¿žç»­çš„idå…¶æ ‡è®°å€¼ä¸å˜ï¼Œä¸€æ—¦æœ‰ä¸è¿žç»­çš„idå‡ºçŽ°ï¼Œåˆ™ä»Žä¸è¿žç»­idè®°å½•å¼€å§‹flagå€¼åŠ 1ï¼Œç„¶åŽç»§ç»­æ¯”è¾ƒï¼Œé‡å¤è¯¥æ­¥éª¤ç›´è‡³ç»“æŸ
            select 
                id, visit_date, people,
                if(@preId = id - 1, @flag, @flag := @flag + 1) as flag,
                @preId := id
            from (
                -- æŸ¥è¯¢äººæµé‡ >= 100 çš„æ•°æ®
                select id, visit_date, people
                from stadium
                where people >= 100
            ) as t1, (select @preId := null, @flag := 0) as t2
        ) as t3 
        group by flag
        having count(flag) >= 3
    ) as t4
    where find_in_set(s.visit_date, t4.peoples)
    order by visit_date asc
   
    -- å˜å½¢ç‰ˆæœ¬ï¼ŒMySQL8.0æ”¯æŒ
    with tmp as (
        -- é€šè¿‡å˜é‡çš„æ–¹å¼å°†idè¿žç»­çš„æ•°æ®è¿›è¡Œæ ‡è®°ï¼Œè¿™ä¸€æ­¥çš„æ“ä½œæ˜¯ä¸ºäº†å¤–å±‚æ ¹æ®flagåˆ†ç»„ç­›é€‰è¿žç»­idæ•°é‡ >= 3 çš„æŸ¥è¯¢åšå‡†å¤‡
        -- åŽŸç†ï¼šè¿žç»­çš„idå…¶æ ‡è®°å€¼ä¸å˜ï¼Œä¸€æ—¦æœ‰ä¸è¿žç»­çš„idå‡ºçŽ°ï¼Œåˆ™ä»Žä¸è¿žç»­idè®°å½•å¼€å§‹flagå€¼åŠ 1ï¼Œç„¶åŽç»§ç»­æ¯”è¾ƒï¼Œé‡å¤è¯¥æ­¥éª¤ç›´è‡³ç»“æŸ
        select 
            id, visit_date, people,
            if(@preId = id - 1, @flag, @flag := @flag + 1) as flag,
            @preId := id
        from (
            -- æŸ¥è¯¢äººæµé‡ >= 100 çš„æ•°æ®
            select id, visit_date, people
            from stadium
            where people >= 100
        ) as t1, (select @preId := null, @flag := 0) as t2
    )
    -- ä½¿ç”¨find_in_set()å‡½æ•°æŸ¥è¯¢æœ€ç»ˆæ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œå¾—åˆ°çš„æ•°æ®å³ä¸ºæœ€ç»ˆéœ€è¦çš„ç»“æžœ
    select id, visit_date, people
    from stadium as s, (
        -- æ ¹æ®å­—æ®µflagåˆ†ç»„å¹¶ç­›é€‰åŒç»„å†…flagæ•°é‡ >= 3 çš„æ—¥æœŸï¼Œå¹¶é€šè¿‡GROUP_CONCAT()å‡½æ•°å°†ç»„å†…æ—¥æœŸè¿žæŽ¥æˆå­—ç¬¦ä¸²ï¼Œä¸ºä¸‹ä¸€æ­¥æŸ¥è¯¢åšå‡†å¤‡
        select group_concat(visit_date) as peoples
        from tmp as t3 
        group by flag
        having count(flag) >= 3
    ) as t4
    where find_in_set(s.visit_date, t4.peoples)
    order by visit_date asc
   
    -- ä¼˜åŒ–ç‰ˆæœ¬ï¼ŒMySQL8.0æ”¯æŒ
    with tmp as (
        -- é€šè¿‡å˜é‡çš„æ–¹å¼å°†idè¿žç»­çš„æ•°æ®è¿›è¡Œæ ‡è®°ï¼Œè¿™ä¸€æ­¥çš„æ“ä½œæ˜¯ä¸ºäº†å¤–å±‚æ ¹æ®flagåˆ†ç»„ç­›é€‰è¿žç»­idæ•°é‡ >= 3 çš„æŸ¥è¯¢åšå‡†å¤‡
        -- åŽŸç†ï¼šè¿žç»­çš„idå…¶æ ‡è®°å€¼ä¸å˜ï¼Œä¸€æ—¦æœ‰ä¸è¿žç»­çš„idå‡ºçŽ°ï¼Œåˆ™ä»Žä¸è¿žç»­idè®°å½•å¼€å§‹flagå€¼åŠ 1ï¼Œç„¶åŽç»§ç»­æ¯”è¾ƒï¼Œé‡å¤è¯¥æ­¥éª¤ç›´è‡³ç»“æŸ
        select 
            id, visit_date, people,
            if(@preId = id - 1, @flag, @flag := @flag + 1) as flag,
            @preId := id
        from (
            -- æŸ¥è¯¢äººæµé‡ >= 100 çš„æ•°æ®
            select id, visit_date, people
            from stadium
            where people >= 100
        ) as t1, (select @preId := null, @flag := 0) as t2
    )
    -- é€šè¿‡flagåšå…³è”è¿›è¡ŒæŸ¥è¯¢ï¼Œå¾—åˆ°æœ€ç»ˆç»“æžœ
    select id, visit_date, people
    from tmp as s
    join (
        -- æ ¹æ®å­—æ®µflagåˆ†ç»„å¹¶ç­›é€‰åŒç»„å†…flagæ•°é‡ >= 3 çš„flag
        select flag
        from tmp as t3 
        group by flag
        having count(flag) >= 3
    ) as t4 on t4.flag = s.flag
    order by visit_date asc
    
    ```
    å¤‡æ³¨ï¼šå¥—å¨ƒè¡Œä¸ºðŸ˜ï¼Œä¸è¿‡ç»ˆç©¶æ˜¯æˆ‘è‡ªå·±å†™çš„ï¼Œæ‰§è¡Œé€Ÿåº¦è¶…è¶Š80%ï¼Œå¯å–œå¯è´ºã€‚
    
2. MySQL è‡ªè¿žæŽ¥

    ```
    select distinct a.* from stadium a,stadium b,stadium c
    where a.people >= 100 and b.people >= 100 and c.people >= 100
    and (
         (a.id = b.id-1 and b.id = c.id -1) or
         (a.id = b.id-1 and a.id = c.id +1) or
         (a.id = b.id+1 and b.id = c.id +1)
    ) 
    order by a.id
    ```
    å¤‡æ³¨ï¼šå¦‚æžœè¦æ±‚è¿žç»­idè¶…è¿‡10ä¸ªæˆ–æ›´å¤šå‘¢ï¼Ÿ
    
3. MySQL è‡ªè¿žæŽ¥ + in

    ```
    SELECT DISTINCT s4.id, s4.visit_date, s4.people 
    FROM stadium s1, stadium s2, stadium s3, stadium s4 
    WHERE s1.id + 1 = s2.id AND s2.id + 1 = s3.id 
    AND s1.people >= 100 AND s2.people >= 100 
    AND s3.people >= 100 
    AND s4.id IN ( s1.id, s2.id, s3.id)
    
    ```
   
4. MySQL in

    ```
    select * from stadium where people>=100 and
    (
    (id in (select id from stadium where people>=100 ) and id+1 in (select id from stadium where people>=100 ) and id+2 in (select id from stadium where people>=100 ))
    or    
    (id in (select id from stadium where people>=100 ) and id+1 in (select id from stadium where people>=100 ) and id-1 in (select id from stadium where people>=100 ))
    or
    (id in (select id from stadium where people>=100 ) and id-1 in (select id from stadium where people>=100 ) and id-2 in (select id from stadium where people>=100 ))
    )
    
    ```
   
5. MySQL count() over() + row_number() over()

    ```
    select id, visit_date, people 
    from (
        select id, visit_date, people, count(*) over(partition by k1) as k2 #3.èŽ·å¾—åŒä¸€è¿žç»­ç»„å†…è®°å½•æ•°
        from (
            select id, visit_date, people, id-row_number() over(order by visit_date) as k1 
            from stadium   #2.æŒ‰æ—¥æœŸæŽ’åº ç”¨id-row_number çš„æ–¹å¼åˆ¤æ–­æ˜¯å¦è¿žç»­
            where people >= 100   #1.æŒ‘é€‰å‡ºäººæµè¶…è¿‡100çš„å¤©æ•°
        ) as a    
    ) as b
    where k2 >= 3
    
    ```
    å¤‡æ³¨ï¼šçª—å£å‡½æ•°æ˜¯çœŸçš„é¦™ï¼Œä½†MySQL8.0æ‰æ”¯æŒï¼Œè¿™å’Œç¬¬ä¸€ä¸ªè§£ç­”æˆ‘çš„æ€è·¯ä¸€æ ·ï¼Œä½†ä½¿ç”¨çš„æ˜¯çª—å£å‡½æ•°ï¼Œæ›´ç®€å•æ˜Žäº†ã€‚
    
6. MySQL with() + in + group by + having

    ```
    with temp as (
        select *, id - row_number() over (order by id asc) as ranking
        from Stadium
        where people >= 100
    )
    select id, visit_date, people
    from temp
    where ranking in (
        select ranking 
        from temp
        group by 1
        having count(1) >= 3
    )
    order by visit_date asc
    
    ```
   
7. MySQL å­æŸ¥è¯¢ + lead() over()

    ```
    select distinct t2.*    
    from(
        select *, 
        lead(people,1)over(order by visit_date  ) as p2,
        lead(people,2)over(order by visit_date ) as p3
        from Stadium 
    )t, Stadium as t2
    where t.people >= 100 and p2 >= 100 and p3 >= 100 
    and t2.id >= t.id and t2.id-2 <= t.id
    
    ```
   
8. MySQL å­æŸ¥è¯¢ + case when then else end + å˜é‡

    ```
    select distinct s.id, s.visit_date, s.people
    from (
        select id, visit_date, people,
        case
        when people >= 100 then @con := @con + 1
        else @con := 0
        end
        as consec
        from stadium, (select @con := 0) as init
    ) as c, stadium as s
    where s.id <= c.id and s.id + 3 > c.id and c.consec >= 3
    
    ```
   
